{% extends 'base.html' %}
{% block head %}
<link rel="stylesheet" href="/static/toastui/toastui-editor.min.css" />
{% endblock %}

{% block header %}
<h1>{{ blog.name}}</h1>
branch {{blog.branch}}
{% endblock %}

{%- block content -%}
<div class="blog-editor">
  <div class="sidebar-tree">
    <ul>
      {% for item in data.tree %}
      {% if item.path == "content" %}
      <li id="{{item.type}}-{{item.sha}}">
        <div onclick=openItem("{{item.type}}","{{item.sha}}");>
          {% if item.type == "tree" %}📁{% endif %} {{item.path}}
        </div>
      </li>
      {% endif %}
      {% endfor %}
    </ul>
  </div>
  <div id="editor" class="editor"></div>
  <div class="sidebar-prop">
    <button type="button" onclick="Save()">Save</button>
    <div id="props" class="props"></div>
  </div>
</div>
{%- endblock -%}

{% block footer %}
<script src="/static/toastui/toastui-editor-all.min.js"></script>
<script type="text/javascript">
  const Editor = toastui.Editor;
  var newLine = "\n";
  var data = "";

  const editor = new Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'wysiwyg',
    previewStyle: 'vertical',
    initialValue: "## select a markdown file from left sidebar to edit"
  });

  async function openItem(type, sha) {
    const response = await fetch(`/blog/{{blog.id}}/${type}/${sha}`);
    data = await response.json();
    if (type === "tree") {
      const newList = document.createElement("ul");
      data.tree.forEach(v => {
        const itemList = document.createElement("li");
        itemList.setAttribute("id", `${v.type}-${v.sha}`)
        const itemContent = document.createElement("div");
        var icon = "";
        if (v.path.endsWith(".md")) {
          icon = "📜 ";
        }
        if (v.path.endsWith(".png") || v.path.endsWith(".jpg") || v.path.endsWith(".JPG")) {
          icon = "🖼️ ";
        }
        if (v.type === "tree") {
          icon = "📁 ";
        }
        const text = document.createTextNode(icon + v.path);
        if (v.path.endsWith(".md") || v.type === "tree") {
          itemContent.setAttribute("onclick", `openItem("${v.type}", "${v.sha}")`)
        }
        itemContent.appendChild(text)
        itemList.appendChild(itemContent)
        newList.appendChild(itemList)
      });
      document.getElementById(`${type}-${sha}`).appendChild(newList)
    } else {
      var md = data.content.split("---\n");
      if (md.length < 2) {
        newLine = "\r\n"
        md = data.content.split("---\r\n");
      }
      editor.setMarkdown(md[2], true);
      const props = md[1].split(newLine);
      document.getElementById("props").innerHTML = ""

      for (let i = 0; i < props.length; i++) {
        const e = props[i];
        var inputType = "input";
        if (e != "" && e.includes(":")) {
          const prop = e.split(":");
          const label = prop[0];
          var text = prop[1];
          if (text.includes(">")) {
            inputType = "textarea"
            for (let x = i + 1; x < props.length; x++) {
              const element = props[x];
              if (element.includes(":")) {
                break;
              }
              text += newLine + element;
            }
          }
          AddInput(label, text, inputType);
        }
      }
    }
  }

  function AddInput(lbl, text, inputType) {
    const container = document.createElement("div");
    const label = document.createElement("div").appendChild(document.createTextNode(lbl.charAt(0).toUpperCase() + lbl.slice(1)));
    const input = document.createElement(inputType);
    input.setAttribute("name", lbl)
    input.setAttribute("class", "postField")
    if (inputType == "textarea") {
      input.appendChild(document.createTextNode(text));

    } else {
      input.setAttribute("value", text)
    }
    container.appendChild(label);
    container.appendChild(input);
    document.getElementById("props").appendChild(container);
  }

  function getContent() {
    const inputs = document.querySelectorAll(".postField")
    var content = "---" + newLine
    inputs.forEach(e => {
      const field = e.getAttribute("name");
      var value = e.value

      if (!value.includes(newLine) || !value.includes("\n")) {
        value += newLine
      }
      if (e.tagName == "TEXTAREA") {
        if (!e.value.includes(">")) {
          value = ">" + newLine + value
        }
      }
      content += field + ":" + value
    });
    content += "---" + newLine + editor.getMarkdown()
    return content
  }

  function Save() {
    console.log(getContent());
  }
</script>
{% endblock%}